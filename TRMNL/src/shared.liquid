{% comment %}
  =============================================================================
  COMPONENT: Chart Assets
  usage: {% render 'chart_assets' %}
  =============================================================================
{% endcomment %}

{% template chart_assets %}
  <script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://trmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://trmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Head Assets
  usage: {% render 'head_assets' %}
  =============================================================================
{% endcomment %}

{% template head_assets %}
  {% render 'chart_assets' %}
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Title Bar
  usage: {% render 'title_bar', instance: 'Energy Prices' %}
  =============================================================================
{% endcomment %}

{% template title_bar %}
  <div class="title_bar">
    <img class="image" src="https://trmnl.com/images/plugins/weather/wi-lightning.svg">
    <span class="title">Frank Energie</span>
    <span class="instance">{{ instance | default: "Energy Prices" }}</span>
  </div>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Energy Chart
  =============================================================================
{% endcomment %}

{% template energy_chart %}
  <div id="{{ id }}" class="{{ chart_class | default: 'w--full grow' }}"></div>

  <script type="text/javascript">
    var rawElectricity = [
      {% for item in electricity %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];
    
    var rawGas = [
      {% for item in gas %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    function transformData(data) {
      if (!data) return [];
      return data.map(function(item) {
        var price = parseFloat(item.total_price);
        if (isNaN(price)) { price = 0; }
        return [
          new Date(item.from).getTime(),
          Math.round(price * 100) / 100
        ];
      });
    }

    var electricityData = transformData(rawElectricity);
    var gasData = transformData(rawGas);

    (function() {
      var chartConfig = {
        chart: {
          type: "spline",
          height: null,
          width: null,
          animation: false,
          backgroundColor: 'transparent',
          spacing: [10, 10, 5, 10],
          events: {
            load: function() {
            }
          }
        },
        accessibility: { enabled: false },
        title: { text: null },
        plotOptions: {
          series: {
            animation: false,
            enableMouseTracking: false,
            states: { hover: { enabled: false } },
            marker: { enabled: false }
          }
        },
        series: [
          {% assign chart_resource = resource_type | default: trmnl.plugin_settings.custom_fields_values.resource_type | default: 'Electricity' %}
          {% if chart_resource == 'Gas' %}
            {
              data: gasData,
              lineWidth: 4,
              color: "#000000",
              name: "Gas",
              zIndex: 2
            }
          {% else %}
            {
              data: electricityData,
              lineWidth: 4,
              color: "#000000",
              name: "Electricity",
              zIndex: 2
            }
          {% endif %}
        ],
        tooltip: { enabled: false },
        legend: { enabled: false },
        yAxis: {
          labels: { style: { fontSize: "16px", color: "#000000" } },
          gridLineDashStyle: "shortdot",
          gridLineWidth: 1,
          gridLineColor: "#000000",
          tickAmount: 5,
          title: { text: null }
        },
        xAxis: {
          type: "datetime",
          labels: { style: { fontSize: "16px", color: "#000000" }, padding: 5, y: 25 },
          lineWidth: 0,
          gridLineDashStyle: "dot",
          tickWidth: 1,
          tickLength: 0,
          gridLineWidth: 1,
          gridLineColor: "#000000",
          tickPixelInterval: 120,
          title: { text: null },
          plotLines: [{
            value: new Date("{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%Y-%m-%dT%H:%M:%S' }}").getTime(),
            color: "#000000",
            width: 2,
            dashStyle: "Dash",
            zIndex: 5,
            label: {
              text: "{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%H:%M' }}",
              style: { fontSize: "12px", fontWeight: "bold", color: "#000000" },
              y: -10,
              x: 5
            }
          }]
        },
        credits: { enabled: false }
      };

      // Wait for DOM to be ready before creating chart
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          requestAnimationFrame(function() {
            Highcharts.chart("{{ id }}", chartConfig);
          });
        });
      } else {
        requestAnimationFrame(function() {
          Highcharts.chart("{{ id }}", chartConfig);
        });
      }
    })();
  </script>
{% endtemplate %}