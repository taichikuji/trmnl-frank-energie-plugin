{% comment %}
  =============================================================================
  COMPONENT: Chart Assets
  usage: {% render 'chart_assets' %}
  =============================================================================
{% endcomment %}

{% template chart_assets %}
  <script src="https://trmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://trmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://trmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Head Assets
  usage: {% render 'head_assets' %}
  =============================================================================
{% endcomment %}

{% template head_assets %}
  {% render 'chart_assets' %}
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Title Bar
  usage: {% render 'title_bar', instance: 'Energy Prices' %}
  =============================================================================
{% endcomment %}

{%- capture svg_logo -%}
<svg xmlns="http://www.w3.org/2000/svg" height="512" width="512" viewBox="0 0 180 180">
  <path
    fill="#E76F55"
    d="M65.5 164.6C31.7 151.3 12.4 121.8 14.1 86 15.7 51.9 43 21.4 77.6 15.2c50.4-9.1 95.9 32.5 91.2 83.4-4.4 49-52.9 81.3-100.5 66.9-.8-.3-1.6-.5-2.8-.9zm8.3-47.2c0 5.9 1.1 12.2-6.1 15.4-.9.4-1.7 3.4-1.2 4.3 1 1.3 3 2.7 4.7 2.7 9 .3 18 .3 26.9 0 1.7 0 4.4-1.7 4.7-3.1.4-1.4-1.6-3.4-2.6-5.1-1.5-2.5-3.9-5-4.2-7.7-.5-7.3-.2-14.6-.2-22V85.8c3.9 0 7.1.1 10.2 0 3.1-.1 5-1.7 5-5s-1.8-4.8-5-4.8H95.7c.7-7.9-1.6-15.3 3-22.2 1.4 2 2.1 4.1 2.8 6.2 1.8 5.4 6 7.4 11.4 5.4 5-1.8 8.2-6.8 7.7-12.1-.5-5.5-4.7-9.7-10.6-10.2-3.6-.2-7.4-.2-11 .1-13.6 1.4-23.5 11.4-25.1 25-.3 2.4-.5 4.9-.8 7.2-3.8 1.6-10.3-1.7-10.6 5-.2 7.8 7.2 4.1 11.3 6.1v30.9z"
  />
</svg>
{%- endcapture -%}
{% template title_bar %}
  <div class="title_bar">
    <img
      class="image"
      src="data:image/svg+xml;base64,{{ svg_logo | base64_encode }}"
      alt="Frank Energie logo">
    <span class="title">{{ title | default: 'Frank Energie' }}</span>
    <span class="instance">{{ instance | default: "Energy Prices" }}</span>
  </div>
{% endtemplate %}

{% comment %}
  =============================================================================
  COMPONENT: Energy Chart
  =============================================================================
{% endcomment %}

{% template energy_chart %}
  <div id="{{ id }}" class="{{ chart_class | default: 'w--full grow' }}"></div>

  <script type="text/javascript">
    var rawElectricity = [
      {% for item in electricity %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];
    
    var rawGas = [
      {% for item in gas %}
        {% assign t_price = item.marketPrice | plus: item.marketPriceTax | plus: item.sourcingMarkupPrice | plus: item.energyTaxPrice %}
        { "from": "{{ item.from | date: '%Y-%m-%dT%H:%M:%SZ' }}", "till": "{{ item.till | date: '%Y-%m-%dT%H:%M:%SZ' }}", "total_price": {{ t_price | default: 0 }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    function transformData(data) {
      if (!data) return [];
      return data.map(function(item) {
        var price = parseFloat(item.total_price);
        if (isNaN(price)) { price = 0; }
        return [
          new Date(item.from).getTime(),
          Math.round(price * 100) / 100
        ];
      });
    }

    var electricityData = transformData(rawElectricity);
    var gasData = transformData(rawGas);

    (function() {
      var chartConfig = {
        chart: {
          type: "spline",
          height: null,
          width: null,
          animation: false,
          backgroundColor: 'transparent',
          spacing: [10, 10, 5, 10],
          events: {
            load: function() {
            }
          }
        },
        accessibility: { enabled: false },
        title: { text: null },
        plotOptions: {
          series: {
            animation: false,
            enableMouseTracking: false,
            states: { hover: { enabled: false } },
            marker: { enabled: false }
          }
        },
        series: [
          {% assign chart_resource = resource_type | default: trmnl.plugin_settings.custom_fields_values.resource_type | default: 'Electricity' %}
          {% if chart_resource == 'Gas' %}
            {
              data: gasData,
              lineWidth: 4,
              color: "#000000",
              name: "Gas",
              zIndex: 2
            }
          {% else %}
            {
              data: electricityData,
              lineWidth: 4,
              color: "#000000",
              name: "Electricity",
              zIndex: 2
            }
          {% endif %}
        ],
        tooltip: { enabled: false },
        legend: { enabled: false },
        yAxis: {
          labels: { style: { fontSize: "16px", color: "#000000" } },
          gridLineDashStyle: "shortdot",
          gridLineWidth: 1,
          gridLineColor: "#000000",
          tickAmount: 5,
          title: { text: null }
        },
        xAxis: {
          type: "datetime",
          labels: { style: { fontSize: "16px", color: "#000000" }, padding: 5, y: 25 },
          lineWidth: 0,
          gridLineDashStyle: "dot",
          tickWidth: 1,
          tickLength: 0,
          gridLineWidth: 1,
          gridLineColor: "#000000",
          tickPixelInterval: 120,
          title: { text: null },
          plotLines: [{
            value: new Date("{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%Y-%m-%dT%H:%M:%S' }}").getTime(),
            color: "#000000",
            width: 2,
            dashStyle: "Dash",
            zIndex: 5,
            label: {
              text: "{{ 'now' | date: '%s' | plus: trmnl.user.utc_offset | date: '%H:%M' }}",
              style: { fontSize: "12px", fontWeight: "bold", color: "#000000" },
              y: -10,
              x: 5
            }
          }]
        },
        credits: { enabled: false }
      };

      // Wait for DOM to be ready before creating chart
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          requestAnimationFrame(function() {
            Highcharts.chart("{{ id }}", chartConfig);
          });
        });
      } else {
        requestAnimationFrame(function() {
          Highcharts.chart("{{ id }}", chartConfig);
        });
      }
    })();
  </script>
{% endtemplate %}