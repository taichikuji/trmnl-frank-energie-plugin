{% comment %}
 =============================================================================
 COMPONENT: Chart Assets
 usage: {% render 'chart_assets' %}
 =============================================================================
{% endcomment %}

{% template chart_assets %}
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Head Assets
 usage: {% render 'head_assets' %}
 =============================================================================
{% endcomment %}

{% template head_assets %}
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://usetrmnl.com/css/latest/plugins.css">
  <script src="https://usetrmnl.com/js/latest/plugins.js"></script>
  {% render 'chart_assets' %}
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Title Bar
 usage: {% render 'title_bar', instance: 'Energy Prices' %}
 =============================================================================
{% endcomment %}

{% template title_bar %}
  <div class="title_bar">
    <img class="image" src="https://usetrmnl.com/images/plugins/weather/wi-lightning.svg">
    <span class="title">Frank Energie</span>
    <span class="instance">{{ instance | default: "Energy Prices" }}</span>
  </div>
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Price Card (Full View)
 =============================================================================
{% endcomment %}

{% template price_card %}
  {% assign current_val = "N/A" %}
  {% assign avg_val = "N/A" %}

  {% if data.size > 0 %}
    {% assign current_val = data[0].total_price | round: 2 %}
    {% assign avg_val = data | map: 'total_price' | sum | divided_by: data.size | round: 2 %}
  {% endif %}

  <div class="grid">
    <div class="item col--span-2">
      <div class="meta"></div>
      <div class="content">
        <span class="value value--{{ current_size | default: "large" }} value--tnums">€{{ current_val }}</span>
        <span class="label">{{ label_now }}</span>
      </div>
    </div>
    <div class="item col--span-1">
      <div class="meta"></div>
      <div class="content">
        <span class="value value--small value--tnums">€{{ avg_val }}</span>
        <span class="label">{{ label_avg }}</span>
      </div>
    </div>
    {% if show_indicator | default: true %}
      <div class="item col--span-1">
        <div class="meta"></div>
        <div class="content">
          <span class="value value--xsmall value--tnums">
            <div class="w--14 h--1.5 mb--2 {{ bar_color }}" style="border-radius: 20px;"></div>
          </span>
          <span class="label">{{ resource_name }}</span>
        </div>
      </div>
    {% endif %}
  </div>
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Mini Stat (Quadrant View)
Params: data, label, type, size (optional class modifier like 'xsmall')
 =============================================================================
{% endcomment %}

{% template mini_stat %}
  {% assign val = "N/A" %}
  {% if data.size > 0 %}
    {% if type == 'avg' %}
      {% assign val = data | map: 'total_price' | sum | divided_by: data.size | round: 2 %}
    {% else %}
      {% assign val = data[0].total_price | round: 2 %}
    {% endif %}
  {% endif %}

  <div class="item">
    <div class="meta"></div>
    <div class="content">
      <span class="value {% if size %}value--{{ size }}{% endif %} value--tnums">€{{ val }}</span>
      <span class="label">{{ label }}</span>
    </div>
  </div>
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Legend Item (Quadrant View)
 =============================================================================
{% endcomment %}

{% template legend_item %}
  <div class="item">
    <div class="meta"></div>
    <div class="content">
      <span class="value value--xxsmall value--tnums">
        <div class="w--12 h--1.5 mb--2 {{ color }}" style="border-radius: 20px;"></div>
        {{ label }}
      </span>
    </div>
  </div>
{% endtemplate %}

{% comment %}
 =============================================================================
 COMPONENT: Energy Chart
 =============================================================================
{% endcomment %}

{% template energy_chart %}
  <div id="{{ id }}" class="w--full {% if variant == 'full' %}flex--grow{% else %}h--full{% endif %}"></div>

  <script type="text/javascript">
    // Pass raw data directly from backend (Manually serialized for Liquid compatibility)
    var rawElectricity = [
      {% for item in electricity %}
        { "from": "{{ item.from }}", "till": "{{ item.till }}", "total_price": {{ item.total_price }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];
    
    var rawGas = [
      {% for item in gas %}
        { "from": "{{ item.from }}", "till": "{{ item.till }}", "total_price": {{ item.total_price }} }
        {% unless forloop.last %},{% endunless %}
      {% endfor %}
    ];

    // Filter and format data on the client side
    var startTime = new Date("{{ 'now' | date: '%Y-%m-%dT%H:00:00.000Z' }}").getTime();

    function transformData(data) {
      if (!data) return [];
      return data
        .filter(function(item) { return new Date(item.from).getTime() >= startTime; })
        .map(function(item) {
          return [
            new Date(item.till).getTime(),
            parseFloat(item.total_price.toFixed(2))
          ];
        });
    }

    var electricityData = transformData(rawElectricity);
    var gasData = transformData(rawGas);

    (function() {
      var chartConfig = {
        chart: {
          type: "spline",
          height: null, // keep null to let it fill container


          width: null,
          animation: false,
          backgroundColor: 'transparent',
          {% if variant == 'sparkline' %}
            margin: [0, 0, 0, 0],
            spacing: [0, 0, 0, 0],
          {% else %}
            spacing: [10, 10, 5, 10],
          {% endif %}
          events: {
            load: function() {
              // Force reflow after chart loads to ensure pattern fills render correctly
              var chart = this;
              setTimeout(function() {
                chart.reflow();
              }, 50);
            }
          }
        },
        title: { text: null },
        plotOptions: {
          series: {
            animation: false,
            enableMouseTracking: false,
            states: { hover: { enabled: false } },
            marker: { enabled: false }
          }
        },
        series: [{
          data: electricityData,
          lineWidth: 4,
          color: "#000000",
          name: "Electricity",
          zIndex: 2
        }, {
          data: gasData,
          lineWidth: 5,
          name: "Gas",
          zIndex: 1,
          color: {
            pattern: {
              image: "https://usetrmnl.com/images/grayscale/gray-5.png",
              width: 12,
              height: 12,
              aspectRatio: 1
            }
          }
        }],
        tooltip: { enabled: false },
        legend: { enabled: false },
        yAxis: {
          {% if variant == 'sparkline' %}
            visible: false,
          {% else %}
            labels: { style: { fontSize: "16px", color: "#000000" } },
            gridLineDashStyle: "shortdot",
            gridLineWidth: 1,
            gridLineColor: "#000000",
            tickAmount: 5,
            title: { text: null }
          {% endif %}
        },
        xAxis: {
          {% if variant == 'sparkline' %}
            visible: false,
          {% else %}
            type: "datetime",
            labels: { style: { fontSize: "16px", color: "#000000" }, padding: 5, y: 25 },
            lineWidth: 0,
            gridLineDashStyle: "dot",
            tickWidth: 1,
            tickLength: 0,
            gridLineWidth: 1,
            gridLineColor: "#000000",
            tickPixelInterval: 120,
            title: { text: null }
          {% endif %}
        },
        credits: { enabled: false }
      };

      // Wait for DOM to be ready before creating chart
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          Highcharts.chart("{{ id }}", chartConfig);
        });
      } else {
        Highcharts.chart("{{ id }}", chartConfig);
      }
    })();
  </script>
{% endtemplate %}